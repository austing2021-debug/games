<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ÁöÆÂÖãÊïèÊê¨ÈÅãÁÆóÊï∏</title>
    <style>
        :root {
            --pikmin-red: #ff4d4d;
            --pikmin-blue: #4da6ff;
            --pikmin-yellow: #ffd700;
            --leaf-green: #76c442;
            --soil-brown: #5d4037;
            --onion-bg: #fff; 
        }
        * { box-sizing: border-box; user-select: none; -webkit-tap-highlight-color: transparent; }
        body {
            margin: 0; padding: 0;
            font-family: "Varela Round", sans-serif;
            color: var(--soil-brown);
            background-color: #e8f5e9;
            display: flex; flex-direction: column; height: 100vh; overflow: hidden;
        }
        header {
            background: var(--leaf-green); padding: 10px 15px;
            display: flex; justify-content: space-between; align-items: center;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        .home-btn {
            text-decoration: none; background: rgba(255,255,255,0.2);
            padding: 5px 12px; border-radius: 20px; color: white; font-weight: bold;
        }
        h1 { margin: 0; color: white; font-size: 1.2rem; }
        .mute-btn { background: none; border: none; font-size: 1.5rem; cursor: pointer; }
        
        .app-container {
            flex: 1; display: flex; flex-direction: column; padding: 15px;
            max-width: 500px; margin: 0 auto; width: 100%;
        }
        
        /* Ë®≠ÂÆöÂçÄÂ°ä */
        .controls { display: flex; gap: 5px; margin-bottom: 10px; flex-wrap: wrap;}
        select {
            padding: 8px; border-radius: 15px; border: 2px solid var(--pikmin-red);
            font-weight: bold; color: var(--soil-brown); background: white; outline: none; text-align: center;
        }
        #opSelect { flex: 0.8; border-color: var(--pikmin-yellow); }
        #levelSelect { flex: 1.2; }
        
        .mode-switch {
            width: 100%; display: flex; background: #ddd; border-radius: 15px; padding: 2px; margin-top: 5px;
        }
        .mode-btn {
            flex: 1; border: none; background: transparent; padding: 8px 0;
            border-radius: 12px; font-weight: bold; color: #666; cursor: pointer;
        }
        .mode-btn.active { background: white; color: var(--pikmin-blue); box-shadow: 0 2px 4px rgba(0,0,0,0.1); }

        /* È°ØÁ§∫ÂçÄ */
        .display-card {
            background: var(--onion-bg); flex: 1; max-height: 250px; border-radius: 30px;
            background-image: repeating-linear-gradient(45deg, transparent, transparent 10px, rgba(0,0,0,0.02) 10px, rgba(0,0,0,0.02) 20px);
            border: 4px solid var(--pikmin-red);
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            position: relative; margin-bottom: 10px; box-shadow: 0 8px 0 rgba(0,0,0,0.1);
        }
        .expression {
            font-size: 3rem; font-weight: 800; display: flex; align-items: center; gap: 5px; flex-wrap: wrap; justify-content: center;
        }
        .num-pellet {
            background: var(--pikmin-red); color: white; width: 60px; height: 60px;
            border-radius: 50%; display: flex; align-items: center; justify-content: center;
            font-size: 1.8rem; box-shadow: inset -3px -3px 0 rgba(0,0,0,0.2); margin: 0 5px;
        }
        .op { color: #888; font-size: 1.5rem; }
        .input-box {
            min-width: 80px; height: 70px; border: 3px dashed var(--soil-brown); border-radius: 15px;
            display: flex; align-items: center; justify-content: center; font-size: 2.5rem;
            color: var(--soil-brown); background: #fcfcfc;
        }
        .input-box.correct { border-color: var(--leaf-green); color: var(--leaf-green); background: #e8f5e9; }
        .input-box.wrong { border-color: var(--pikmin-red); animation: shake 0.4s; }

        .recite-nav { display: none; width: 100%; justify-content: space-between; padding: 0 30px; margin-top: 15px; }
        .nav-btn {
            background: var(--pikmin-blue); color: white; border: none; width: 50px; height: 50px;
            border-radius: 50%; font-size: 1.5rem; box-shadow: 0 4px 0 #205ebb;
        }
        .nav-btn:active { transform: translateY(4px); box-shadow: none; }

        /* ÈçµÁõ§ */
        .keypad { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; padding-bottom: 10px; }
        .key {
            background: white; border: 2px solid #ddd; border-radius: 15px; height: 55px;
            font-size: 1.5rem; font-weight: bold; color: var(--soil-brown); box-shadow: 0 4px 0 #ccc;
        }
        .key:active { transform: translateY(4px); box-shadow: none; background: #eee; }
        .key-c { background: #ffcccc; border-color: #ff9999; color: #d32f2f; }
        .key-ok { background: var(--pikmin-yellow); border-color: #fbc02d; }
        
        .hidden { display: none !important; }
        @keyframes shake { 0%, 100% {transform: translateX(0);} 25% {transform: translateX(-5px);} 75% {transform: translateX(5px);} }
    </style>
</head>
<body>
    <header>
        <a href="index.html" class="home-btn">‚óÄ Âü∫Âú∞</a>
        <h1>Êê¨ÈÅãÁÆóÊï∏</h1>
        <button class="mute-btn" id="muteBtn" onclick="toggleMute()">üîî</button>
    </header>

    <div class="app-container">
        <div class="controls">
            <select id="opSelect" onchange="initGame()">
                <option value="*">√ó ‰πòÊ≥ï</option>
                <option value="+">Ôºã Âä†Ê≥ï</option>
                <option value="-">Ôºç Ê∏õÊ≥ï</option>
            </select>
            <select id="levelSelect" onchange="initGame()">
                <option value="1">Level 1</option>
                <option value="2">Level 2</option>
                <option value="3">Level 3</option>
                <option value="4">Level 4</option>
                <option value="5">Level 5</option>
                <option value="6">Level 6</option>
                <option value="7">Level 7</option>
                <option value="8">Level 8</option>
                <option value="9">Level 9</option>
                <option value="random">üåü ÈöäÈï∑ÊåëÊà∞</option>
            </select>
            <div class="mode-switch">
                <button class="mode-btn active" id="modeRecite" onclick="setMode('recite')">ËÉåË™¶</button>
                <button class="mode-btn" id="modeQuiz" onclick="setMode('quiz')">Ê∏¨È©ó</button>
            </div>
        </div>

        <div class="display-card">
            <div class="expression" id="expressionArea"></div>
            <div class="recite-nav" id="reciteNav">
                <button class="nav-btn" onclick="prevRecite()">‚óÄ</button>
                <button class="nav-btn" onclick="nextRecite()">‚ñ∂</button>
            </div>
        </div>

        <div class="keypad" id="keypad">
            <button class="key" onclick="pressKey('1')">1</button>
            <button class="key" onclick="pressKey('2')">2</button>
            <button class="key" onclick="pressKey('3')">3</button>
            <button class="key" onclick="pressKey('4')">4</button>
            <button class="key" onclick="pressKey('5')">5</button>
            <button class="key" onclick="pressKey('6')">6</button>
            <button class="key" onclick="pressKey('7')">7</button>
            <button class="key" onclick="pressKey('8')">8</button>
            <button class="key" onclick="pressKey('9')">9</button>
            <button class="key key-c" onclick="pressKey('C')">C</button>
            <button class="key" onclick="pressKey('0')">0</button>
            <button class="key key-ok" onclick="checkAnswer()">Âì®Â≠ê</button>
        </div>
    </div>

    <script>
        let currentMode = 'recite';
        let currentLevel = 1;
        let currentOp = '*';
        let questionData = { num1: 1, num2: 1, ans: 1 };
        let currentInput = '';
        let isMuted = false;
        let isProcessing = false;

        const praises = ["‰ªªÂãôÂÆåÊàêÔºÅ", "Â•ΩÊ£íÁöÑÈÅãÈÄÅÔºÅ", "ÁöÆÂÖãÊïèÂæàÈñãÂøÉÔºÅ", "ÈöäÈï∑Â§™Âº∑‰∫ÜÔºÅ", "ÂÆåÁæéÊê¨ÈÅãÔºÅ"];

        window.onload = () => initGame();

        function initGame() {
            const lSel = document.getElementById('levelSelect');
            const oSel = document.getElementById('opSelect');
            currentLevel = lSel.value === 'random' ? 'random' : parseInt(lSel.value);
            currentOp = oSel.value;
            currentInput = '';
            
            generateQuestion(true); // reset
            render();
        }

        function setMode(mode) {
            currentMode = mode;
            document.getElementById('modeRecite').className = mode === 'recite' ? 'mode-btn active' : 'mode-btn';
            document.getElementById('modeQuiz').className = mode === 'quiz' ? 'mode-btn active' : 'mode-btn';
            currentInput = '';
            render();
        }

        function generateQuestion(isReset = false) {
            let n1, n2;
            let level = currentLevel === 'random' ? Math.floor(Math.random()*9)+1 : currentLevel;
            let variable = Math.floor(Math.random()*9) + 1; // 1-9

            if (isReset && currentMode === 'recite') variable = 1;

            if (currentOp === '*') {
                // ‰πòÊ≥ïÔºöLevel * 1~9
                n1 = level; n2 = variable;
            } else if (currentOp === '+') {
                // Âä†Ê≥ïÔºöLevel + 1~9 (‰æãÂ¶Ç Level 1 Â∞±ÊòØ 1+?, Level 9 Â∞±ÊòØ 9+?)
                n1 = level; n2 = variable;
            } else if (currentOp === '-') {
                // Ê∏õÊ≥ïÔºöÁ¢∫‰øùÁ≠îÊ°àÊòØÊ≠£Êï∏„ÄÇ (Level + 1~9) - Level = ?
                // È°åÁõÆË®≠Ë®àÔºöË¢´Ê∏õÊï∏ = Level + variable, Ê∏õÊï∏ = Level
                // ÈÄôÊ®£È°åÁõÆÊúÉËÆäÊàê: (5+3) - 5 = 3. 
                // ÊàñËÄÖÊõ¥Áõ¥Ë¶∫‰∏ÄÈªûÔºö X - Level = ? (Á¢∫‰øù X > Level)
                n2 = level; 
                n1 = n2 + variable; // Ë¢´Ê∏õÊï∏‰∏ÄÂÆöÊØîËºÉÂ§ß
            }

            questionData = { num1: n1, num2: n2, ans: eval(`${n1} ${currentOp} ${n2}`) };
            // Â¶ÇÊûúÊòØËÉåË™¶‰∏îÊ≤íresetÔºåÂ∞±ËÆì variable ÈÅûÂ¢û (ÈÄôÂú® render ÊôÇËôïÁêÜ)
        }

        function nextRecite() {
            // ËÉåË™¶Ê®°Âºè‰∏ãÁöÑÁ∞°ÂñÆÈÅûÂ¢ûÈÇèËºØ
            if (currentLevel === 'random') {
                generateQuestion();
            } else {
                // ÂòóË©¶ËÆìÁ¨¨‰∫åÂÄãÊï∏Â≠ó+1
                let nextVar;
                if(currentOp === '-') {
                    // Ê∏õÊ≥ïÊôÇÔºåÂ¢ûÂä†Ë¢´Ê∏õÊï∏ (e.g. 6-5, 7-5, 8-5)
                    nextVar = (questionData.num1 - questionData.num2) + 1;
                    if(nextVar > 9) nextVar = 1;
                    questionData.num1 = questionData.num2 + nextVar;
                } else {
                    nextVar = questionData.num2 + 1;
                    if(nextVar > 9) nextVar = 1;
                    questionData.num2 = nextVar;
                }
                questionData.ans = eval(`${questionData.num1} ${currentOp} ${questionData.num2}`);
            }
            render();
        }

        function prevRecite() {
             // Á∞°ÂåñÔºöÁõ¥Êé•Èö®Ê©üÊàñËÄÖÁ∞°ÂñÆÊ∏õ
             generateQuestion(); 
             render();
        }

        function render() {
            const expArea = document.getElementById('expressionArea');
            const reciteNav = document.getElementById('reciteNav');
            const keypad = document.getElementById('keypad');
            const { num1, num2, ans } = questionData;
            
            let opSymbol = currentOp === '*' ? '√ó' : currentOp;

            let html = `
                <div class="num-pellet">${num1}</div>
                <span class="op">${opSymbol}</span>
                <div class="num-pellet" style="background:var(--pikmin-blue)">${num2}</div>
                <span class="op">=</span>
            `;

            if (currentMode === 'recite') {
                html += `<div class="num-pellet" style="background:var(--pikmin-yellow);color:#5d4037">${ans}</div>`;
                reciteNav.style.display = 'flex';
                keypad.classList.add('hidden');
                speakEquation(num1, num2, ans);
            } else {
                html += `<div class="input-box ${currentInput ? '' : 'empty'}">${currentInput || '?'}</div>`;
                reciteNav.style.display = 'none';
                keypad.classList.remove('hidden');
            }
            expArea.innerHTML = html;
        }

        function pressKey(key) {
            if (isProcessing) return;
            if (key !== 'C' && key !== 'OK') speakText(key);

            if (key === 'C') currentInput = '';
            else if (key === 'OK') checkAnswer();
            else if (currentInput.length < 3) currentInput += key;
            
            // Êõ¥Êñ∞Áï´Èù¢Ëº∏ÂÖ•Ê°Ü
            const inputBox = document.querySelector('.input-box');
            if(inputBox) inputBox.innerText = currentInput;
        }

        async function checkAnswer() {
            if (!currentInput || isProcessing) return;
            
            const userAnswer = parseInt(currentInput);
            const inputBox = document.querySelector('.input-box');

            if (userAnswer === questionData.ans) {
                isProcessing = true;
                inputBox.classList.add('correct');
                playWhistle();
                await wait(600);
                speakText("Á≠îÂ∞ç‰∫Ü");
                await wait(800);
                speakText(praises[Math.floor(Math.random() * praises.length)]);
                await wait(1500);
                
                generateQuestion(); // ‰∏ã‰∏ÄÈ°å
                currentInput = '';
                isProcessing = false;
                render();
            } else {
                inputBox.classList.add('wrong');
                playFailSound();
                setTimeout(() => {
                    inputBox.classList.remove('wrong');
                    currentInput = '';
                    inputBox.innerText = '?';
                }, 1000);
            }
        }

        // --- Ë™ûÈü≥ ---
        function toggleMute() { isMuted = !isMuted; document.getElementById('muteBtn').innerText = isMuted ? 'üîï' : 'üîî'; }
        
        function speakText(text) {
            if (isMuted) return;
            window.speechSynthesis.cancel();
            const u = new SpeechSynthesisUtterance(text);
            u.lang = 'zh-TW'; u.pitch = 1.3; window.speechSynthesis.speak(u);
        }

        function speakEquation(n1, n2, ans) {
            let opText = "Êàê‰ª•";
            if(currentOp === '+') opText = "Âä†";
            if(currentOp === '-') opText = "Ê∏õ";
            speakText(`${n1} ${opText} ${n2} Á≠âÊñº ${ans}`);
        }

        // --- Èü≥Êïà (Á∂≠ÊåÅÂéüÊ®£) ---
        const AudioContext = window.AudioContext || window.webkitAudioContext;
        const audioCtx = new AudioContext();
        function playWhistle() { /* ÂèÉËÄÉ‰∏ä‰∏ÄÂÄãÁâàÊú¨ÁöÑ‰ª£Á¢ºÔºåÁÇ∫ÁØÄÁúÅÁØáÂπÖÁúÅÁï•ÔºåË´ãÁõ¥Êé•Áî®‰∏ä‰∏ÄÁâàÁöÑ playWhistle */ 
            if (isMuted) return; if (audioCtx.state === 'suspended') audioCtx.resume();
            const t = audioCtx.currentTime; const o1 = audioCtx.createOscillator(), o2 = audioCtx.createOscillator(), g = audioCtx.createGain();
            o1.freq = 1200; o2.freq = 1250; o1.connect(g); o2.connect(g); g.connect(audioCtx.destination);
            o1.start(t); o2.start(t); g.gain.setValueAtTime(0.2, t); g.gain.linearRampToValueAtTime(0, t+0.3); o1.stop(t+0.3); o2.stop(t+0.3);
        }
        function playFailSound() {
             if (isMuted) return; if (audioCtx.state === 'suspended') audioCtx.resume();
             const t = audioCtx.currentTime; const o = audioCtx.createOscillator(), g = audioCtx.createGain();
             o.type='triangle'; o.frequency.value=200; o.frequency.linearRampToValueAtTime(100, t+0.4);
             o.connect(g); g.connect(audioCtx.destination); o.start(t); o.stop(t+0.4);
        }
        function wait(ms) { return new Promise(r => setTimeout(r, ms)); }
    </script>
</body>
</html>
