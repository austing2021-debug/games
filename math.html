<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>çš®å…‹æ•æ¬é‹ç®—æ•¸</title>
    <style>
        :root {
            --pikmin-red: #ff4d4d;
            --pikmin-blue: #4da6ff;
            --pikmin-yellow: #ffd700;
            --leaf-green: #76c442;
            --soil-brown: #5d4037;
            --onion-bg: #fff; 
        }

        * { box-sizing: border-box; user-select: none; -webkit-tap-highlight-color: transparent; }

        body {
            margin: 0;
            padding: 0;
            font-family: "Varela Round", sans-serif;
            color: var(--soil-brown);
            background-color: #e8f5e9; /* æ·ºè‰åœ°è‰² */
            display: flex;
            flex-direction: column;
            height: 100vh;
            overflow: hidden;
        }

        /* é ‚éƒ¨å°èˆª */
        header {
            background: var(--leaf-green);
            padding: 10px 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }

        .home-btn {
            text-decoration: none;
            background: rgba(255,255,255,0.2);
            padding: 5px 12px;
            border-radius: 20px;
            color: white;
            font-weight: bold;
            font-size: 0.9rem;
        }

        h1 { margin: 0; color: white; font-size: 1.2rem; }

        .mute-btn {
            background: none; border: none; font-size: 1.5rem; cursor: pointer;
        }

        /* ä¸»å®¹å™¨ */
        .app-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            padding: 15px;
            max-width: 500px;
            margin: 0 auto;
            width: 100%;
        }

        /* æ§åˆ¶åˆ— */
        .controls {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
        }

        select {
            flex: 1;
            padding: 8px;
            border-radius: 15px;
            border: 2px solid var(--pikmin-red);
            font-weight: bold;
            color: var(--soil-brown);
            background: white;
            text-align: center;
            outline: none;
        }

        .mode-switch {
            display: flex;
            background: #ddd;
            border-radius: 15px;
            padding: 2px;
        }

        .mode-btn {
            border: none;
            background: transparent;
            padding: 8px 15px;
            border-radius: 12px;
            font-weight: bold;
            color: #666;
            cursor: pointer;
        }

        .mode-btn.active {
            background: white;
            color: var(--pikmin-blue);
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        /* é¡¯ç¤ºå€ (åƒæ´‹è”¥å¤ªç©ºèˆ¹) */
        .display-card {
            background: var(--onion-bg);
            flex: 1;
            max-height: 220px;
            border-radius: 30px;
            /* æ¨¡æ“¬æ´‹è”¥çš„æ¢ç´‹ */
            background-image: repeating-linear-gradient(45deg, transparent, transparent 10px, rgba(0,0,0,0.02) 10px, rgba(0,0,0,0.02) 20px);
            border: 4px solid var(--pikmin-red);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            position: relative;
            margin-bottom: 10px;
            box-shadow: 0 8px 0 rgba(0,0,0,0.1);
        }

        .expression {
            font-size: 3.5rem;
            font-weight: 800;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        /* æ•¸å­—è®Šæˆåƒ Pellet (é¤Šåˆ†) */
        .num-pellet {
            background: var(--pikmin-red);
            color: white;
            width: 60px;
            height: 60px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2rem;
            box-shadow: inset -3px -3px 0 rgba(0,0,0,0.2);
        }
        
        .op { color: #888; font-size: 1.5rem; }
        
        .input-box {
            min-width: 80px;
            height: 70px;
            border: 3px dashed var(--soil-brown);
            border-radius: 15px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2.5rem;
            color: var(--soil-brown);
            background: #fcfcfc;
        }
        
        .input-box.correct { border-color: var(--leaf-green); color: var(--leaf-green); background: #e8f5e9; }
        .input-box.wrong { border-color: var(--pikmin-red); animation: shake 0.4s; }

        /* å°èˆªæŒ‰éˆ• */
        .recite-nav {
            display: none;
            width: 100%;
            justify-content: space-between;
            padding: 0 30px;
            margin-top: 15px;
        }
        .nav-btn {
            background: var(--pikmin-blue);
            color: white;
            border: none;
            width: 50px; height: 50px;
            border-radius: 50%;
            font-size: 1.5rem;
            box-shadow: 0 4px 0 #205ebb;
        }
        .nav-btn:active { transform: translateY(4px); box-shadow: none; }

        /* éµç›¤ */
        .keypad {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            padding-bottom: 10px;
        }

        .key {
            background: white;
            border: 2px solid #ddd;
            border-radius: 15px;
            height: 55px;
            font-size: 1.5rem;
            font-weight: bold;
            color: var(--soil-brown);
            box-shadow: 0 4px 0 #ccc;
        }
        .key:active { transform: translateY(4px); box-shadow: none; background: #eee; }

        .key-c { background: #ffcccc; border-color: #ff9999; color: #d32f2f; box-shadow: 0 4px 0 #e57373; }
        .key-ok { background: var(--pikmin-yellow); border-color: #fbc02d; color: var(--soil-brown); box-shadow: 0 4px 0 #f9a825; }

        /* å‹•ç•« */
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-5px); }
            75% { transform: translateX(5px); }
        }

        .hidden { display: none !important; }
        
        .pikmin-decor {
            position: absolute;
            top: -25px;
            font-size: 2rem;
            animation: bounce 2s infinite;
        }
        @keyframes bounce { 0%, 100% {transform: translateY(0);} 50% {transform: translateY(-10px);} }

    </style>
</head>
<body>

    <header>
        <a href="index.html" class="home-btn">â—€ åŸºåœ°</a>
        <h1>æ¬é‹ç®—æ•¸</h1>
        <button class="mute-btn" id="muteBtn" onclick="toggleMute()">ğŸ””</button>
    </header>

    <div class="app-container">
        <div class="controls">
            <select id="levelSelect" onchange="initGame()">
                <option value="1">1 çš„é‹é€</option>
                <option value="2">2 çš„é‹é€</option>
                <option value="3">3 çš„é‹é€</option>
                <option value="4">4 çš„é‹é€</option>
                <option value="5">5 çš„é‹é€</option>
                <option value="6">6 çš„é‹é€</option>
                <option value="7">7 çš„é‹é€</option>
                <option value="8">8 çš„é‹é€</option>
                <option value="9">9 çš„é‹é€</option>
                <option value="random">ğŸŒŸ éšŠé•·æŒ‘æˆ° (2-9)</option>
            </select>
            
            <div class="mode-switch">
                <button class="mode-btn active" id="modeRecite" onclick="setMode('recite')">èƒŒèª¦</button>
                <button class="mode-btn" id="modeQuiz" onclick="setMode('quiz')">æ¸¬é©—</button>
            </div>
        </div>

        <div class="display-card">
            <div class="pikmin-decor" style="right: 20px;">ğŸŒ±</div>
            <div class="expression" id="expressionArea"></div>
            
            <div class="recite-nav" id="reciteNav">
                <button class="nav-btn" onclick="prevRecite()">â—€</button>
                <button class="nav-btn" onclick="nextRecite()">â–¶</button>
            </div>
        </div>

        <div class="keypad" id="keypad">
            <button class="key" onclick="pressKey('1')">1</button>
            <button class="key" onclick="pressKey('2')">2</button>
            <button class="key" onclick="pressKey('3')">3</button>
            <button class="key" onclick="pressKey('4')">4</button>
            <button class="key" onclick="pressKey('5')">5</button>
            <button class="key" onclick="pressKey('6')">6</button>
            <button class="key" onclick="pressKey('7')">7</button>
            <button class="key" onclick="pressKey('8')">8</button>
            <button class="key" onclick="pressKey('9')">9</button>
            <button class="key key-c" onclick="pressKey('C')">C</button>
            <button class="key" onclick="pressKey('0')">0</button>
            <button class="key key-ok" onclick="checkAnswer()">å“¨å­</button>
        </div>
    </div>

    <script>
        let currentMode = 'recite';
        let currentBase = 1;
        let currentMultiplier = 1;
        let currentInput = '';
        let isMuted = false;
        let isProcessing = false;

        const praises = ["ä»»å‹™å®Œæˆï¼", "å¥½æ£’çš„é‹é€ï¼", "çš®å…‹æ•å¾ˆé–‹å¿ƒï¼", "éšŠé•·å¤ªå¼·äº†ï¼", "å®Œç¾æ¬é‹ï¼"];

        window.onload = () => initGame();

        function initGame() {
            const select = document.getElementById('levelSelect');
            currentBase = select.value === 'random' ? 'random' : parseInt(select.value);
            currentMultiplier = 1;
            if(currentBase === 'random') randomizeQuestion();
            render();
        }

        function setMode(mode) {
            currentMode = mode;
            document.getElementById('modeRecite').className = mode === 'recite' ? 'mode-btn active' : 'mode-btn';
            document.getElementById('modeQuiz').className = mode === 'quiz' ? 'mode-btn active' : 'mode-btn';
            currentInput = '';
            initGame();
        }

        function randomizeQuestion() {
            window.currentQ = {
                base: Math.floor(Math.random() * 8) + 2,
                mult: Math.floor(Math.random() * 9) + 1
            };
        }

        function render() {
            const expArea = document.getElementById('expressionArea');
            const reciteNav = document.getElementById('reciteNav');
            const keypad = document.getElementById('keypad');

            if (!window.currentQ) {
                if(currentBase === 'random') randomizeQuestion();
                else window.currentQ = { base: currentBase, mult: currentMultiplier };
            }

            const { base, mult } = window.currentQ;

            if (currentMode === 'recite') {
                const ans = base * mult;
                // èƒŒèª¦æ¨¡å¼ï¼šæ•¸å­—é¡¯ç¤ºåœ¨ç´…åœˆåœˆå…§
                expArea.innerHTML = `
                    <div class="num-pellet">${base}</div>
                    <span class="op">Ã—</span>
                    <div class="num-pellet" style="background:var(--pikmin-blue)">${mult}</div>
                    <span class="op">=</span>
                    <div class="num-pellet" style="background:var(--pikmin-yellow);color:#5d4037">${ans}</div>
                `;
                reciteNav.style.display = 'flex';
                keypad.classList.add('hidden');
                speakEquation(base, mult, ans);
            } else {
                // æ¸¬é©—æ¨¡å¼
                expArea.innerHTML = `
                    <div class="num-pellet">${base}</div>
                    <span class="op">Ã—</span>
                    <div class="num-pellet" style="background:var(--pikmin-blue)">${mult}</div>
                    <span class="op">=</span>
                    <div class="input-box ${currentInput ? '' : 'empty'}">${currentInput || '?'}</div>
                `;
                reciteNav.style.display = 'none';
                keypad.classList.remove('hidden');
            }
        }

        function nextRecite() {
            if (currentBase === 'random') randomizeQuestion();
            else { window.currentQ.mult++; if (window.currentQ.mult > 9) window.currentQ.mult = 1; }
            render();
        }

        function prevRecite() {
            if (currentBase === 'random') randomizeQuestion();
            else { window.currentQ.mult--; if (window.currentQ.mult < 1) window.currentQ.mult = 9; }
            render();
        }

        function pressKey(key) {
            if (isProcessing) return;
            if (key !== 'C' && key !== 'OK') speakText(key);

            if (key === 'C') currentInput = '';
            else if (key === 'OK') checkAnswer();
            else if (currentInput.length < 3) currentInput += key;
            
            render();
        }

        async function checkAnswer() {
            if (!currentInput || isProcessing) return;
            const { base, mult } = window.currentQ;
            const correctAnswer = base * mult;
            const userAnswer = parseInt(currentInput);
            const inputBox = document.querySelector('.input-box');

            if (userAnswer === correctAnswer) {
                isProcessing = true;
                inputBox.classList.add('correct');
                playWhistle(); // ç­”å°æ’­æ”¾å“¨å­è²
                await wait(600);
                speakText("ç­”å°äº†");
                await wait(800);
                const praise = praises[Math.floor(Math.random() * praises.length)];
                speakText(praise);
                await wait(2000);
                nextQuestion();
            } else {
                inputBox.classList.add('wrong');
                playFailSound();
                setTimeout(() => {
                    inputBox.classList.remove('wrong');
                    currentInput = '';
                    render();
                }, 1000);
            }
        }

        function nextQuestion() {
            isProcessing = false;
            currentInput = '';
            if (currentBase === 'random') randomizeQuestion();
            else window.currentQ.mult = Math.floor(Math.random() * 9) + 1;
            render();
        }

        function toggleMute() {
            isMuted = !isMuted;
            document.getElementById('muteBtn').innerText = isMuted ? 'ğŸ”•' : 'ğŸ””';
        }

        function speakText(text) {
            if (isMuted) return;
            window.speechSynthesis.cancel();
            const u = new SpeechSynthesisUtterance(text);
            u.lang = 'zh-TW';
            u.pitch = 1.3; 
            window.speechSynthesis.speak(u);
        }

        function speakEquation(b, m, a) {
            speakText(`${b} æˆä»¥ ${m} ç­‰æ–¼ ${a}`);
        }

        function wait(ms) { return new Promise(r => setTimeout(r, ms)); }

        // --- çš®å…‹æ•éŸ³æ•ˆè¨­è¨ˆ ---
        const AudioContext = window.AudioContext || window.webkitAudioContext;
        const audioCtx = new AudioContext();

        function playWhistle() {
            if (isMuted) return;
            if (audioCtx.state === 'suspended') audioCtx.resume();
            const t = audioCtx.currentTime;
            
            // æ¨¡æ“¬å“¨å­ï¼šå…©å€‹é«˜é »æ­£å¼¦æ³¢æ»‘å‹•
            const osc1 = audioCtx.createOscillator();
            const osc2 = audioCtx.createOscillator();
            const gain = audioCtx.createGain();

            osc1.type = 'sine';
            osc2.type = 'sine';

            osc1.frequency.setValueAtTime(1200, t);
            osc1.frequency.linearRampToValueAtTime(1800, t + 0.1);
            osc1.frequency.linearRampToValueAtTime(1200, t + 0.3);

            osc2.frequency.setValueAtTime(1250, t); // ç¨å¾®å¤±èª¿ç”¢ç”Ÿé¡«éŸ³
            osc2.frequency.linearRampToValueAtTime(1850, t + 0.1);
            osc2.frequency.linearRampToValueAtTime(1250, t + 0.3);

            osc1.connect(gain);
            osc2.connect(gain);
            gain.connect(audioCtx.destination);

            osc1.start(t);
            osc2.start(t);
            gain.gain.setValueAtTime(0.3, t);
            gain.gain.linearRampToValueAtTime(0, t + 0.3);
            
            osc1.stop(t + 0.3);
            osc2.stop(t + 0.3);
        }

        function playFailSound() {
            if (isMuted) return;
            if (audioCtx.state === 'suspended') audioCtx.resume();
            const t = audioCtx.currentTime;
            const osc = audioCtx.createOscillator();
            const gain = audioCtx.createGain();
            
            osc.type = 'triangle';
            osc.frequency.setValueAtTime(200, t);
            osc.frequency.linearRampToValueAtTime(100, t + 0.4);
            
            osc.connect(gain);
            gain.connect(audioCtx.destination);
            osc.start(t);
            gain.gain.setValueAtTime(0.3, t);
            gain.gain.linearRampToValueAtTime(0, t + 0.4);
            osc.stop(t + 0.4);
        }
    </script>
</body>
</html>